---
title: "Calibration of OD (Cuvette & Microplate Readers)"
author: "Hermina"
Date: "2024-02-21"
output:
  html_document:
    df_print: paged
    code_folding: hide
    toc: true
    toc_float:
      smooth_scroll: false
  pdf_document:
    toc: true
---

# Overview

Analysis of data generated by following the protocol called "Calibration to CFUs.docx".

Fairly exhaustive calibrations were done for the microplate spectrophotometers (hereafter referred to generally as "plate readers" or specifically by the name of each instrument, Synergy H1 or Epoch2). The data for all species, culture conditions, and temperatures during the OD readings are found in the data.frame `all_calib.data`. The parameters of the linear regressions that should be used to convert from OD into CFU estimates (i.e., OD is independent variable and CFU is dependent variable) can be found in the data.frame `all_calibrations`. The slopes of the linear regressions correlating CFU with OD (i.e., OD is the *dependent* variable and CFU is the *in*dependent variable) can be found in the data.frame `all_cellSizes`.

A single calibration attempt was made for the cuvette reader. The data for the calibration can be found in the `cuvette.df` data.frame and the linear regression can be found in `cuvette_lm`.


```{r, loadEnv}
# load environment
library(tidyverse)
library(readxl) # for importing data directly from Excel sheet
library(broom) # for easy fitting of several lm's from the same df

# set theme for all plots
fave_theme <- theme_light() + # see other options at https://ggplot2.tidyverse.org/reference/ggtheme.html
  theme(text = element_text(size=15), # larger text size for titles & axes
        panel.grid.major = element_blank(), # remove major gridlines
        panel.grid.minor = element_blank()) # remove minor gridlines
theme_set(fave_theme)
```

# Cuvette Reader

This cuvette reader calibration curve uses stationary phase cells grown in test tubes and incubated in the terrible grey/green shaker. It may be worthwhile to consider re-doing this calibration...

On the other hand, the data may be sufficient to be able to roughly figure out how the cuvette reader compares to either of the 2 plate readers. Then it's only necessary to properly calibrate the plate readers to the CFU's because afterwards it will be possible to convert to cuvette reader OD-values.

```{r, cuvette_loadData}
# load the data from Excel
cuvette.df <- read_excel("calibration_spectrophotometers--15Feb24.xlsx", sheet="cuvette")
  # trim off the last 2 rows because these are meaningless
cuvette.df <- cuvette.df[1:(nrow(cuvette.df)-2),]

# log transform the OD and cell density data
cuvette.df <- cuvette.df %>% mutate(log10_OD = log10(A600),
                              log10_density = log10(`Inferred Cell Density (1/mL)`)) %>%
                 filter(log10_OD > -Inf)
```


```{r, cuvette}
# calibration curve for cuvette reader
ggplot(cuvette.df %>% filter(A600 > 0),
       aes(y=`Inferred Cell Density (1/mL)`,
           x=A600,
           colour=Sample)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)")

# fit linear model
cuvette_lm <- with(cuvette.df, lm(log10_density ~ log10_OD + Sample))
summary(cuvette_lm)
```

Therefore it seems that BSC004 and BSC008 are rather similar to one another while BSC015 is more different

 I wonder if this is because of the different growth rates of the strains: BSC004 and BSC008 grow more slowly and so may not have yet reached stationary phase. Meanwhile BSC015 grows more quickly and so is more likely to have reached stationary phase.
 It may be good to repeat the calibration for cells that are in early exponential phase VS those that have been at stationary phase for some time to see the effect.
 This would also be useful information to know how the cells are changing in size during the growth curve.

 On the other hand, Stevenson et al. 2016 Fig 2 is showing that larger cells have a steeper OD calibration curve while smaller cells have a more shallow curve.
 So now this is making me wonder if the stickiness of BSC015 when grown in the glass test tubes and green/grey incubator is actually the problem...
 I suppose I could compare the actual size/consistency of the cells using the camera of the flow cytometer...

# Microplate Readers

## Stationary Phase grown in Test Tube: 3sp at $28^\circ C$

The first time I tried this I ended up using a sketchy culture for BSC015. The cultures were grown to stationary phase in test tubes and incubated in the grey/green incubator. BSC015 had a clumpy / sedimented culture so I took mostly from the top. Anyway I imagine this will impact the calibration for both the plate reader and cuvette (above).

```{r, plate_loadData}
# load the microplate OD data
synergy.df <- read_excel("calibration_spectrophotometers--15Feb24.xlsx", sheet="microplate H1") %>%
                pivot_longer(cols=`25_rep1`:`40_rep6`,
                                   names_to=c("Temp", "Rep"),
                                   names_pattern="(.*)_rep(.)",
                                   values_to="OD") # reorganize the shape of the dataframe
epoch.df <- read_excel("calibration_spectrophotometers--15Feb24.xlsx", sheet="microplate Epoch") %>%
                pivot_longer(cols=`25_rep1`:`40_rep6`,
                                   names_to=c("Temp", "Rep"),
                                   names_pattern="(.*)_rep(.)",
                                   values_to="OD") # reorganize the shape of the dataframe

# load the microplate CFU data
plateCFU.df <- read_excel("calibration_spectrophotometers--15Feb24.xlsx", sheet="microplate_CFU")
```

For the microplate data it is necessary to do the OD subtraction manually. Make sure to baseline the data separately for the $25^\circ C$ versus $40^\circ C$ conditions. This is because the refractive index of a liquid depends on the temperature of that liquid. So we may expect to see a different baseline value at these different temperatures. 

Before we do that, let's make sure there's no trend over time in the blank OD values. In particular, if the baseline is indeed different between the two temperatures, I'm worried that the temperature of the liquid does not actually reach $40^\circ C$ within 5 minutes (i.e., the time of replicate 1) and so we should discard some of the earlier replicates until the temperature stabilizes. There may also be a trend for the $25^\circ C$ if there is condensation on the top of the membrane ...and if that condensation actually goes away within 20 minutes...

```{r, baseline}
# baseline subtract using the blanks as well as the bottom 3 lowest dilutions for each sample

# check if there's any systematic trend in the baseline value
baseline_trend <- rbind(synergy.df %>% add_column(machine="Synergy"), # combine the data from the 2 plate readers
                        epoch.df %>% add_column(machine="Epoch")) %>%
                    filter(Dilution < 5e-06) %>%                      # keep blanks & 3 lowest dilutions
                      # get median value for each temperature & replicate
                      select(-Dilution, -Sample) %>% group_by(Temp, Rep, machine) %>%
                          summarise(medianBlankOD = median(OD, na.rm=TRUE),
                                    ICR_lo = quantile(OD, probs=0.25),
                                    ICR_hi = quantile(OD, probs=0.75))
ggplot(baseline_trend, aes(x=Rep, y=medianBlankOD, colour=Temp)) +
  facet_wrap(vars(machine), scales="free") +
  geom_errorbar(aes(ymin=ICR_lo, ymax=ICR_hi), width=0.2) +
  geom_point()
rm(baseline_trend)

# looks like there's no trend other than individual well variation
# baseline everything in the same way
synergy.df <- inner_join(synergy.df %>% filter(Dilution < 5e-06) %>%
                            select(-Dilution, -Sample) %>% # get the blanks & calculate mean value for each Temp & Rep
                                group_by(Temp, Rep) %>% summarise(medianBlankOD = median(OD, na.rm=TRUE)),
                          synergy.df %>% filter(Dilution > 5e-06) # add the medianBlankOD back to the data without the samples used for blanking
                        ) %>% mutate(baselinedOD = OD-medianBlankOD)

epoch.df <- inner_join(epoch.df %>% filter(Dilution < 5e-06) %>%
                          select(-Dilution, -Sample) %>% # get the blanks & calculate mean value for each Temp & Rep
                              group_by(Temp, Rep) %>% summarise(medianBlankOD = median(OD, na.rm=TRUE)),
                       epoch.df %>% filter(Dilution > 5e-06) # add the medianBlankOD back to the data without the samples used for blanking
                      ) %>% mutate(baselinedOD = OD-medianBlankOD)
```
Next we have to estimate the CFU values for each sample using the various replicates.

```{r, microplate1}
# estimate the mean CFU of each sample
plateCFU.df <- plateCFU.df %>% mutate(CFU_per_mL = `CFU per 100uL`/Dilution*10) %>%
                group_by(Sample) %>% summarise(meanCFU = mean(CFU_per_mL),
                                               sdCFU = sd(CFU_per_mL))

# combine the CFU data with the OD data & infer the CFU for each dilution used in the OD data
synergy.df <- left_join(synergy.df, plateCFU.df) %>%
                mutate(inferred_meanDensity = meanCFU*Dilution,
                       inferred_sdDensity = sdCFU*Dilution) %>%
                  select(-meanCFU, -sdCFU)

epoch.df <- left_join(epoch.df, plateCFU.df) %>%
                mutate(inferred_meanDensity = meanCFU*Dilution,
                       inferred_sdDensity = sdCFU*Dilution) %>%
                  select(-meanCFU, -sdCFU)
```

Now we are finally ready to plot the calibration plot.

```{r, microplate2}
synergy.df <- synergy.df %>%
                mutate(log10_OD = log10(baselinedOD),
                       log10_density = log10(inferred_meanDensity)) %>%
                 filter(log10_OD > -Inf)

# plot the calibration curve for the Synergy
ggplot(synergy.df,
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Sample)) +
  facet_wrap(vars(Temp)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Synergy: Stat. phase in Tubes")

# remove some of the data points because it seems we are hitting up against the limit of detection
synergy.df<- synergy.df %>% filter(inferred_meanDensity > 1e+06,
                                   baselinedOD > 2e-02)

ggplot(synergy.df,
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Sample)) +
  facet_wrap(vars(Temp)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Synergy: Stat. phase in Tubes (OD > 0.02)")

# check for significant differences between strains / growth conditions / temperature during OD reading
synergy_lm <- with(synergy.df, lm(log10_density ~ log10_OD + Sample + Temp))
summary(synergy_lm)
rm(synergy_lm)

# estimate linear models for each condition and store the estimates
temp.fitVals = synergy.df %>% group_by(Sample, Temp) %>%
                 do(tidy(lm(log10_density ~ log10_OD, data=.), conf.int=TRUE))

all_calibrations <- temp.fitVals %>% rename(OD_temp=Temp) %>% mutate(Phase="stationary",
                                                                     Flask="tube",
                                                                     Incubation_temp=28,
                                                                     Detector="synergy")
rm(temp.fitVals)

# repeat for the cell size linear regression
temp.fitVals = synergy.df %>% group_by(Sample, Temp) %>%
                 do(tidy(lm(log10_OD ~ log10_density, data=.), conf.int=TRUE)) %>%
                    filter(term == "log10_density")

all_cellSizes <- temp.fitVals %>% rename(OD_temp=Temp) %>% mutate(Phase="stationary",
                                                                     Flask="tube",
                                                                     Incubation_temp=28,
                                                                     Detector="synergy")
rm(temp.fitVals)

### Do the same thing for the Epoch data

epoch.df <- epoch.df %>%
              mutate(log10_OD = log10(baselinedOD),
                     log10_density = log10(inferred_meanDensity)) %>%
                 filter(log10_OD > -Inf)

# plot the calibration curve for the Epoch
ggplot(epoch.df,
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Sample)) +
  facet_wrap(vars(Temp)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Epoch: Stat. phase in Tubes")

# remove some of the data points because it seems we are hitting up against the limit of detection
epoch.df <- epoch.df %>% filter(inferred_meanDensity > 5e+04,
                                baselinedOD > 8e-03)
ggplot(epoch.df,
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Sample)) +
  facet_wrap(vars(Temp)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Epoch: Stat. phase in Tubes (OD > 0.008)")

# check for significant differences between strains / growth conditions / temperature during OD reading
epoch_lm <- with(epoch.df, lm(log10_density ~ log10_OD + Sample + Temp))
summary(epoch_lm)
rm(epoch_lm)

# estimate linear models for each condition and store the estimates
temp.fitVals = epoch.df %>% group_by(Sample, Temp) %>%
                 do(tidy(lm(log10_density ~ log10_OD, data=.), conf.int=TRUE))

temp.fitVals <- temp.fitVals %>% rename(OD_temp=Temp) %>% mutate(Phase="stationary",
                                                                 Flask="tube",
                                                                 Incubation_temp=28,
                                                                 Detector="epoch")
all_calibrations <- rbind(all_calibrations, temp.fitVals)
all_calibrations$OD_temp <- as.numeric(all_calibrations$OD_temp)
rm(temp.fitVals)

# repeat for the cell size linear regression
temp.fitVals = epoch.df %>% group_by(Sample, Temp) %>%
                 do(tidy(lm(log10_OD ~ log10_density, data=.), conf.int=TRUE)) %>%
                    filter(term == "log10_density")

temp.fitVals <- temp.fitVals %>% rename(OD_temp=Temp) %>% mutate(Phase="stationary",
                                                                     Flask="tube",
                                                                     Incubation_temp=28,
                                                                     Detector="epoch")
all_cellSizes <- rbind(all_cellSizes, temp.fitVals)
all_cellSizes$OD_temp <- as.numeric(all_cellSizes$OD_temp)


# store the raw data
all_calib.data <- rbind(synergy.df %>% mutate(Detector="synergy"),
                        epoch.df %>% mutate(Detector="epoch")) %>%
                    rename(OD_temp=Temp) %>% select(-Rep, -medianBlankOD, -Dilution, -OD) %>%
                      mutate(Phase="stationary",
                             Flask="tube",
                             Incubation_temp=28)
all_calib.data$OD_temp <- as.numeric(all_calib.data$OD_temp)
rm(epoch.df, synergy.df, plateCFU.df, temp.fitVals)
```
Okay so it seems that the temperature of the plate itself has little impact on the calibration curve. That's a good thing to know!


## Exponential Phase BSC015 grown in plate reader ($25^\circ C$ & $40^\circ C$) & Erlenmeyer ($28^\circ C$)

The second time I tried this I used mid-exponential phase cultures grown in the best conditions we have in the lab: either in an Erlenmeyer or in the plate reader. And since we have 2 plate readers, I incubated the same culture either at $25^\circ C$ or at $40^\circ C$. The purpose of this was to understand whether the plate readers could actually incubate the culture to similarly good conditions as the Erlenmeyer.

```{r, plate_load&baseline_Data}
# load the microplate OD data
synergy.df <- read_excel("calibration_spectrophotometers--22Feb24.xlsx", sheet="microplate H1") %>%
                pivot_longer(cols=`25_rep1`:`40_rep6`,
                                   names_to=c("Temp", "Rep"),
                                   names_pattern="(.*)_rep(.)",
                                   values_to="OD") # reorganize the shape of the dataframe
epoch.df <- read_excel("calibration_spectrophotometers--22Feb24.xlsx", sheet="microplate Epoch") %>%
                pivot_longer(cols=`25_rep1`:`40_rep6`,
                                   names_to=c("Temp", "Rep"),
                                   names_pattern="(.*)_rep(.)",
                                   values_to="OD") # reorganize the shape of the dataframe

# load the microplate CFU data
plateCFU.df <- read_excel("calibration_spectrophotometers--22Feb24.xlsx", sheet="microplate_CFU")

# baseline subtract using the blanks as well as the bottom 3 lowest dilutions for each sample

# check if there's any systematic trend in the baseline value
baseline_trend <- rbind(synergy.df %>% add_column(machine="Synergy"), # combine the data from the 2 plate readers
                        epoch.df %>% add_column(machine="Epoch")) %>%
                    filter(Dilution < 5e-06) %>%                      # keep blanks & 3 lowest dilutions
                      # get median value for each temperature & replicate
                      select(-Dilution, -Sample) %>% group_by(Temp, Rep, machine) %>%
                          summarise(medianBlankOD = median(OD, na.rm=TRUE),
                                    ICR_lo = quantile(OD, probs=0.25),
                                    ICR_hi = quantile(OD, probs=0.75))
ggplot(baseline_trend, aes(x=Rep, y=medianBlankOD, colour=Temp)) +
  facet_wrap(vars(machine), scales="free") +
  geom_errorbar(aes(ymin=ICR_lo, ymax=ICR_hi), width=0.2) +
  geom_point()
rm(baseline_trend)

# in this case it seems there's a difference in the baselines for different incubation temperatures, but only for the Epoch2...

# baseline everything in the same way as before
synergy.df <- inner_join(synergy.df %>% filter(Dilution < 5e-06) %>%
                            select(-Dilution, -Sample) %>% # get the blanks & calculate mean value for each Temp & Rep
                                group_by(Temp, Rep) %>% summarise(medianBlankOD = median(OD, na.rm=TRUE)),
                          synergy.df %>% filter(Dilution > 5e-06) # add the medianBlankOD back to the data without the samples used for blanking
                        ) %>% mutate(baselinedOD = OD-medianBlankOD)

epoch.df <- inner_join(epoch.df %>% filter(Dilution < 5e-06) %>%
                          select(-Dilution, -Sample) %>% # get the blanks & calculate mean value for each Temp & Rep
                              group_by(Temp, Rep) %>% summarise(medianBlankOD = median(OD, na.rm=TRUE)),
                       epoch.df %>% filter(Dilution > 5e-06) # add the medianBlankOD back to the data without the samples used for blanking
                      ) %>% mutate(baselinedOD = OD-medianBlankOD)
```

```{r, calibration_Exp_BSC015}
# estimate the mean CFU of each sample
plateCFU.df <- plateCFU.df %>% mutate(CFU_per_mL = `CFU per 100uL`/Dilution*10) %>%
                group_by(Sample, Phase, Incubation) %>%
                  summarise(meanCFU = mean(CFU_per_mL),
                            sdCFU = sd(CFU_per_mL))

# combine the CFU data with the OD data & infer the CFU for each dilution used in the OD data
synergy.df <- left_join(synergy.df, plateCFU.df) %>%
                mutate(inferred_meanDensity = meanCFU*Dilution,
                       inferred_sdDensity = sdCFU*Dilution) %>%
                  select(-meanCFU, -sdCFU)

epoch.df <- left_join(epoch.df, plateCFU.df) %>%
                mutate(inferred_meanDensity = meanCFU*Dilution,
                       inferred_sdDensity = sdCFU*Dilution) %>%
                  select(-meanCFU, -sdCFU)

## do the calibration:
synergy.df <- synergy.df %>%
                mutate(log10_OD = log10(baselinedOD),
                       log10_density = log10(inferred_meanDensity)) %>%
                 filter(log10_OD > -Inf)

# plot the calibration curve for the Synergy
ggplot(synergy.df,
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Incubation)) +
  facet_wrap(vars(Temp)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Synergy: BSC015 exponential")

# remove some of the data points because it seems we are hitting up against the limit of detection
synergy.df <- synergy.df %>% filter(inferred_meanDensity > 5e+04,
                                    baselinedOD > 5e-03,
                                    Temp==25) # drop the 40C because it looks even worse than 25C
ggplot(synergy.df,
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Incubation)) +
  facet_wrap(vars(Temp)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Synergy: BSC015 exponential (OD > 0.005)")


# check for significant differences between growth conditions
synergy_lm <- with(synergy.df, lm(log10_density ~ log10_OD + Incubation))
summary(synergy_lm)
rm(synergy_lm)

# estimate linear models for each condition and store the estimates
temp.fitVals = synergy.df %>% group_by(Sample, Incubation) %>%
                  do(tidy(lm(log10_density ~ log10_OD, data=.), conf.int=TRUE))
temp.fitVals <- temp.fitVals %>% separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask")) %>%
                  mutate(Phase="exponential", OD_temp=25, Detector="synergy")
temp.fitVals$Incubation_temp <- as.numeric(temp.fitVals$Incubation_temp)

all_calibrations <- rbind(all_calibrations, temp.fitVals)
rm(temp.fitVals)

# repeat for the cell size linear regression
temp.fitVals = synergy.df %>% group_by(Sample, Incubation) %>%
                 do(tidy(lm(log10_OD ~ log10_density, data=.), conf.int=TRUE)) %>%
                    filter(term == "log10_density")
temp.fitVals <- temp.fitVals %>% separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask")) %>%
                  mutate(Phase="exponential", OD_temp=25, Detector="synergy")
temp.fitVals$Incubation_temp <- as.numeric(temp.fitVals$Incubation_temp)

all_cellSizes <- rbind(all_cellSizes, temp.fitVals)
rm(temp.fitVals)

### Do the same thing for the Epoch data

epoch.df <- epoch.df %>%
              mutate(log10_OD = log10(baselinedOD),
                     log10_density = log10(inferred_meanDensity)) %>%
                 filter(log10_OD > -Inf)

# plot the calibration curve for the Epoch
ggplot(epoch.df%>% filter(inferred_meanDensity > 1e+04,
                           baselinedOD > 5e-03),
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Incubation)) +
  facet_wrap(vars(Temp)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Epoch: BSC015 exponential")

# remove some of the data points because it seems we are hitting up against the limit of detection
epoch.df <- epoch.df %>% filter(inferred_meanDensity > 1e+04,
                           baselinedOD > 5e-03,
                           Temp==25) # again remove OD acquisition temp of 40C
ggplot(epoch.df,                          
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Incubation)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Epoch: BSC015 exponential (OD > 0.005)")

# check for significant differences between growth conditions
epoch_lm <- with(epoch.df, lm(log10_density ~ log10_OD + Incubation))
summary(epoch_lm)
rm(epoch_lm)

# estimate linear models for each condition and store the estimates
temp.fitVals = epoch.df %>% group_by(Sample, Incubation) %>%
                  do(tidy(lm(log10_density ~ log10_OD, data=.), conf.int=TRUE))
temp.fitVals <- temp.fitVals %>% separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask")) %>%
                  mutate(Phase="exponential", OD_temp=25, Detector="epoch")
temp.fitVals$Incubation_temp <- as.numeric(temp.fitVals$Incubation_temp)

all_calibrations <- rbind(all_calibrations, temp.fitVals)
rm(temp.fitVals)

# repeat for the cell size linear regression
temp.fitVals = epoch.df %>% group_by(Sample, Incubation) %>%
                 do(tidy(lm(log10_OD ~ log10_density, data=.), conf.int=TRUE)) %>%
                    filter(term == "log10_density")
temp.fitVals <- temp.fitVals %>% separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask")) %>%
                  mutate(Phase="exponential", OD_temp=25, Detector="epoch")
temp.fitVals$Incubation_temp <- as.numeric(temp.fitVals$Incubation_temp)

all_cellSizes <- rbind(all_cellSizes, temp.fitVals)

# store the raw data
temp.data <- rbind(synergy.df %>% mutate(Detector="synergy"),
                   epoch.df %>% mutate(Detector="epoch")) %>% ungroup() %>%
               select(-Rep, -medianBlankOD, -Dilution, -OD, -Temp) %>%
                 separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask")) %>%
                   mutate(OD_temp=25)
temp.data$Incubation_temp <- as.numeric(temp.data$Incubation_temp)
all_calib.data <- rbind(all_calib.data, temp.data)

rm(epoch.df, synergy.df, plateCFU.df, temp.fitVals, temp.data)
```

The $25^\circ C$ and $28^\circ C$ calibration curves for the Synergy data are weird. The trend appears to not be very linear even though things should be above the threshold of detection... I decided to discard the OD measured at $40^\circ C$ because this looks even worse than the OD measured at the lower temperature.

Note that for the Synergy data, there is no statistically significant difference between the $25^\circ C$ and $28^\circ C$ calibration curves. I suppose this is because the trends look weird a non-linear...

## Stationary Phase Cells grown in plate reader: 4sp at $25^\circ C$ & $40^\circ C$

I wanted to understand whether cells change in size after 48h of incubation in the plate reader. This is important because large changes in size will impact our estimates of the number of cells present in the culture at carrying capacity. I used both plate readers, one set to $25^\circ C$ and the other set to $40^\circ C$.

Note that the CFU's were much higher here for some samples (e.g., BSC004 at $25^\circ C$) so I only kept the single lowest dilution (i.e., instead of the 3 lowest dilutions) along with the real negative controls to calculate the median baseline value.

```{r, plate_load&check_baseline}
# load the microplate OD data
synergy.df <- read_excel("calibration_spectrophotometers--26Feb24.xlsx", sheet="microplate H1") %>%
                pivot_longer(cols =`rep1`:`rep6`,
                             names_to = "Rep",
                             names_pattern="rep(.)",
                             values_to="OD") %>% # reorganize the shape of the dataframe
                  mutate(OD_Temp = 25)
epoch.df <- read_excel("calibration_spectrophotometers--26Feb24.xlsx", sheet="microplate Epoch") %>%
              pivot_longer(cols =`rep1`:`rep6`,
                             names_to = "Rep",
                             names_pattern="rep(.)",
                             values_to="OD") %>% # reorganize the shape of the dataframe
                  mutate(OD_Temp = 40)

# load the microplate CFU data
plateCFU.df <- read_excel("calibration_spectrophotometers--26Feb24.xlsx", sheet="microplate_CFU")

# baseline subtract using the blanks as well as the bottom 1 lowest dilution for each sample

# check if there's any systematic trend in the baseline value
baseline_trend <- rbind(synergy.df %>% add_column(machine="Synergy"), # combine the data from the 2 plate readers
                        epoch.df %>% add_column(machine="Epoch")) %>%
                    filter(Dilution < 1e-06) %>%                      # keep blanks & 3 lowest dilutions
                      # get median value for each reader & replicate
                      select(-Dilution, -Sample) %>% group_by(Rep, machine, Incubation) %>%
                          summarise(medianBlankOD = median(OD, na.rm=TRUE),
                                    ICR_lo = quantile(OD, probs=0.25, na.rm=TRUE),
                                    ICR_hi = quantile(OD, probs=0.75, na.rm=TRUE))
ggplot(baseline_trend, aes(x=Rep, y=medianBlankOD, colour=Incubation)) +
  facet_wrap(vars(machine), scales="free") +
  geom_errorbar(aes(ymin=ICR_lo, ymax=ICR_hi), width=0.2) +
  geom_point()
rm(baseline_trend)
```
Well, this is annoying. I think what happened with the 25C plate in the Epoch2 is that I was very frustrated with the previous plate (40C plate). The Epoch was giving this stupid error message and refusing to read my sample, requiring reboot of the instrument/computer each time I attempted to scan it again. Meanwhile I was also running a sedimentation assay at the same time. Anyway, by the time I got to the 25C plate in the Epoch2, I think I knocked it while I was loading it into the plate reader. So there was liquid on top of the sealing film that obscured the OD measurements... I should probably discard this data altogether but I don't want to do that so instead let's use just the last time point for the calibration.

```{r, baseline2}
# remove the first 5 replicates in the "25C plate" Epoch data
epoch.df <- rbind(epoch.df %>% filter(Incubation == "25C plate reader", Rep==6),
                  epoch.df %>% filter(Incubation == "40C plate reader", Rep<6))
# & remove the 6th replicate in the "40C plate" Epoch data (that one is all NA's anyway)


# now, after excluding problematic values, baseline similarly to previous data:
synergy.df <- inner_join(synergy.df %>% filter(Dilution < 1e-06) %>%
                            select(-Dilution, -Sample) %>% # get the blanks & calculate mean value for each Temp & Rep
                                group_by(Rep, Incubation) %>% summarise(medianBlankOD = median(OD, na.rm=TRUE)),
                          synergy.df %>% filter(Dilution > 1e-06) # add the medianBlankOD back to the data without the samples used for blanking
                        ) %>% mutate(baselinedOD = OD-medianBlankOD)

epoch.df <- inner_join(epoch.df %>% filter(Dilution < 1e-06) %>%
                          select(-Dilution, -Sample) %>% # get the blanks & calculate mean value for each Temp & Rep
                              group_by(Rep, Incubation) %>% summarise(medianBlankOD = median(OD, na.rm=TRUE)),
                       epoch.df %>% filter(Dilution > 1e-06) # add the medianBlankOD back to the data without the samples used for blanking
                      ) %>% mutate(baselinedOD = OD-medianBlankOD)

# estimate the mean CFU of each sample
plateCFU.df <- plateCFU.df %>% mutate(CFU_per_mL = `CFU per 100uL`/Dilution*10) %>%
                group_by(Sample, Phase, Incubation) %>%
                  summarise(meanCFU = mean(CFU_per_mL),
                            sdCFU = sd(CFU_per_mL))

# combine the CFU data with the OD data & infer the CFU for each dilution used in the OD data
synergy.df <- left_join(synergy.df, plateCFU.df) %>%
                mutate(inferred_meanDensity = meanCFU*Dilution,
                       inferred_sdDensity = sdCFU*Dilution) %>%
                  select(-meanCFU, -sdCFU)

epoch.df <- left_join(epoch.df, plateCFU.df) %>%
                mutate(inferred_meanDensity = meanCFU*Dilution,
                       inferred_sdDensity = sdCFU*Dilution) %>%
                  select(-meanCFU, -sdCFU)
```
```{r, calibration_STA_platereaders}
## do the calibration:
synergy.df <- synergy.df %>%
                mutate(log10_OD = log10(baselinedOD),
                       log10_density = log10(inferred_meanDensity)) %>%
                 filter(log10_OD > -Inf,
                        baselinedOD > 1e-13)

# plot the calibration curve for the Synergy
ggplot(synergy.df,
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Incubation)) +
  facet_wrap(vars(Sample)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Synergy: 4sp stationary grown at 25C, 40C")

# remove some of the data points because it seems we are hitting up against the limit of detection
synergy.df <- rbind(synergy.df %>% filter(Sample=="BSC004", baselinedOD > 1e-02),
                    synergy.df %>% filter(Sample=="BSC008", Incubation=="25C plate reader", baselinedOD > 2e-02),
                    synergy.df %>% filter(Sample=="BSC008", Incubation=="40C plate reader", baselinedOD > 5e-02),
                    synergy.df %>% filter(Sample=="BSC015", Incubation=="25C plate reader", baselinedOD > 2e-02),
                    synergy.df %>% filter(Sample=="BSC015", Incubation=="40C plate reader", baselinedOD > 1e-02),
                    synergy.df %>% filter(Sample=="CK101", baselinedOD > 2e-02))

ggplot(synergy.df,
       aes(x=inferred_meanDensity,
           y=baselinedOD,
           colour=Incubation)) +
  facet_wrap(vars(Sample)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(x="CFU Cell Density (1/mL)", y="OD (Absorbance at 600nm)",
       title="Synergy: OD > 1.4 is unreliable")

# remove the most concentrated samples because of violation of the Beer-Lambert law
synergy.df <- synergy.df %>% filter(baselinedOD < 1.4)

ggplot(synergy.df,
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Incubation)) +
  facet_wrap(vars(Sample)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Synergy: 4sp stationary grown in readers at 25C, 40C")

# check for significant differences between growth conditions
synergy_lm <- with(synergy.df, lm(log10_density ~ log10_OD + Sample + Incubation + Sample:Incubation))
summary(synergy_lm)
rm(synergy_lm)

# estimate linear models for each condition and store the estimates
temp.fitVals = synergy.df %>% group_by(Sample, Incubation) %>%
                  do(tidy(lm(log10_density ~ log10_OD, data=.), conf.int=TRUE))
temp.fitVals <- temp.fitVals %>% separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask")) %>%
                  mutate(Phase="stationary", OD_temp=25, Detector="synergy")
temp.fitVals$Incubation_temp <- as.numeric(temp.fitVals$Incubation_temp)

all_calibrations <- rbind(all_calibrations, temp.fitVals)
rm(temp.fitVals)

# repeat for the cell size linear regression
temp.fitVals = synergy.df %>% group_by(Sample, Incubation) %>%
                 do(tidy(lm(log10_OD ~ log10_density, data=.), conf.int=TRUE)) %>%
                    filter(term == "log10_density")
temp.fitVals <- temp.fitVals %>% separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask")) %>%
                  mutate(Phase="stationary", OD_temp=25, Detector="synergy")
temp.fitVals$Incubation_temp <- as.numeric(temp.fitVals$Incubation_temp)

all_cellSizes <- rbind(all_cellSizes, temp.fitVals)
rm(temp.fitVals)


### Do the same thing for the Epoch data

epoch.df <- epoch.df %>%
              mutate(log10_OD = log10(baselinedOD),
                     log10_density = log10(inferred_meanDensity)) %>%
                 filter(log10_OD > -Inf)

# plot the calibration curve for the Epoch
ggplot(epoch.df,
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Incubation)) +
  facet_wrap(vars(Sample)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Epoch: 4sp stationary grown at 25C, 40C")

# remove some of the data points because it seems we are hitting up against the limit of detection
epoch.df <- rbind(epoch.df %>% filter(Sample %in% c("BSC004", "BSC008"), Incubation=="25C plate reader", baselinedOD > 5e-03),
                  epoch.df %>% filter(Sample %in% c("BSC015", "CK101"), Incubation=="25C plate reader", baselinedOD > 1e-02),
                  epoch.df %>% filter(Sample=="BSC015", Incubation=="40C plate reader", baselinedOD > 1e-02),
                  epoch.df %>% filter(Sample=="BSC008", Incubation=="40C plate reader", baselinedOD > 2e-02))

ggplot(epoch.df,
       aes(x=inferred_meanDensity,
           y=baselinedOD,
           colour=Incubation)) +
  facet_wrap(vars(Sample)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(x="CFU Cell Density (1/mL)", y="OD (Absorbance at 600nm)",
       title="Epoch: OD > 1.1 is unreliable")

# remove the most concentrated samples because of violation of the Beer-Lambert law
epoch.df <- epoch.df %>% filter(baselinedOD < 1.1)

ggplot(epoch.df,
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Incubation)) +
  facet_wrap(vars(Sample)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Epoch: 4sp stationary grown at 25C, 40C")

ggplot(epoch.df,
       aes(x=inferred_meanDensity,
           y=baselinedOD,
           colour=Incubation)) +
  facet_wrap(vars(Sample)) +
  scale_x_log10(breaks=c(1e+05, 1e+10)) +
  scale_y_log10() +
  geom_smooth(method="lm", linewidth=0.2) +
  geom_point() +
  scale_colour_discrete(labels=c("25C", "40C"),
                        type=c("#619CFF", "#F8766D")) +
  labs(x="CFU Cell Density (1/mL)", y="OD (600nm)",
       colour="Temperature",
       title="Stationary phase cultures (48h)")

# check for significant differences between growth conditions
epoch_lm <- with(epoch.df, lm(log10_density ~ log10_OD + Sample + Incubation + Sample:Incubation))
summary(epoch_lm)
rm(epoch_lm)

# estimate linear models for each condition and store the estimates
temp.fitVals = epoch.df %>% group_by(Sample, Incubation) %>%
                  do(tidy(lm(log10_density ~ log10_OD, data=.), conf.int=TRUE))
temp.fitVals <- temp.fitVals %>% separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask")) %>%
                  mutate(Phase="stationary", OD_temp=40, Detector="epoch")
temp.fitVals$Incubation_temp <- as.numeric(temp.fitVals$Incubation_temp)

all_calibrations <- rbind(all_calibrations, temp.fitVals)
rm(temp.fitVals)

# repeat for the cell size linear regression
temp.fitVals = epoch.df %>% group_by(Sample, Incubation) %>%
                 do(tidy(lm(log10_OD ~ log10_density, data=.), conf.int=TRUE)) %>%
                    filter(term == "log10_density")
temp.fitVals <- temp.fitVals %>% separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask")) %>%
                  mutate(Phase="stationary", OD_temp=40, Detector="epoch")
temp.fitVals$Incubation_temp <- as.numeric(temp.fitVals$Incubation_temp)

all_cellSizes <- rbind(all_cellSizes, temp.fitVals)

# store the raw data
temp.data <- rbind(synergy.df %>% mutate(Detector="synergy", OD_temp=25),
                   epoch.df %>% mutate(Detector="epoch", OD_temp=40)) %>% ungroup() %>%
               select(-Rep, -medianBlankOD, -Dilution, -OD) %>%
                 separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask"))
temp.data$Incubation_temp <- as.numeric(temp.data$Incubation_temp)
all_calib.data <- rbind(all_calib.data, temp.data)

rm(epoch.df, synergy.df, plateCFU.df, temp.fitVals, temp.data)
```
Notice the much smaller intercept for the linear regression (i.e., the fact that the whole calibration line is vertically much lower) when incubated at $40^\circ C$ as compared to $25^\circ C$. This happens for both BSC008 and BSC015. This is showing that a much smaller fraction of the total culture actually contains viable cells after 48h of growth when incubated at $40^\circ C$.

I plotted the cell density on the x-axis and the OD on the y-axis so that we can observe the data as expected. Here we can see violation of the Beer-Lambert law at sufficiently high cell concentrations: the OD is no longer linearly correlated with the CFU. Where this happens ofc depends on the detector so I use different cut-offs for the different detectors.

Open question: can we quantify this cell death during starvation at different temperatures using live/dead staining? How does the temperature of heat stress and exposure time of heat stress impact cell viability?

## Exponential Phase Cells grown in Erlenmeyer: 3sp at $28^\circ C$ & $40^\circ C$

Finally, the last set of calibration data I have (...so far...) is here. 3 species in exponential phase. Although I did find a small but statistically significant difference between exponential phase cultures grown in an Erlenmeyer flask *versus* in the plate reader, here I have opted to look at cells all grown in Erlenmeyer flasks just for simplicity.

```{r, plate_load&baseline}
# load the microplate OD data
synergy.df <- read_excel("calibration_spectrophotometers--28Feb24.xlsx", sheet="microplate H1") %>%
                pivot_longer(cols =`rep1`:`rep6`,
                             names_to = "Rep",
                             names_pattern="rep(.)",
                             values_to="OD") %>% # reorganize the shape of the dataframe
                  mutate(OD_Temp = 28)
epoch.df <- read_excel("calibration_spectrophotometers--28Feb24.xlsx", sheet="microplate Epoch") %>%
              pivot_longer(cols =`rep1`:`rep6`,
                             names_to = "Rep",
                             names_pattern="rep(.)",
                             values_to="OD") %>% # reorganize the shape of the dataframe
                  mutate(OD_Temp = 28)

# load the microplate CFU data
plateCFU.df <- read_excel("calibration_spectrophotometers--28Feb24.xlsx", sheet="microplate_CFU")

# baseline subtract using the blanks as well as the bottom 3 lowest dilutions for each sample

# check if there's any systematic trend in the baseline value
baseline_trend <- rbind(synergy.df %>% add_column(machine="Synergy"), # combine the data from the 2 plate readers
                        epoch.df %>% add_column(machine="Epoch")) %>%
                    filter(Dilution < 5e-06) %>%                      # keep blanks & 3 lowest dilutions
                      # get median value for each reader & replicate
                      select(-Dilution, -Sample) %>% group_by(Rep, machine) %>%
                          summarise(medianBlankOD = median(OD, na.rm=TRUE),
                                    ICR_lo = quantile(OD, probs=0.25, na.rm=TRUE),
                                    ICR_hi = quantile(OD, probs=0.75, na.rm=TRUE))
ggplot(baseline_trend, aes(x=Rep, y=medianBlankOD)) +
  facet_wrap(vars(machine), scales="free") +
  geom_errorbar(aes(ymin=ICR_lo, ymax=ICR_hi), width=0.2) +
  geom_point()
rm(baseline_trend)


# baseline similarly to previous data:
synergy.df <- inner_join(synergy.df %>% filter(Dilution < 5e-06) %>%
                            select(-Dilution, -Sample) %>% # get the blanks & calculate mean value for each Temp & Rep
                                group_by(Rep, Incubation) %>% summarise(medianBlankOD = median(OD, na.rm=TRUE)),
                          synergy.df %>% filter(Dilution > 5e-06) # add the medianBlankOD back to the data without the samples used for blanking
                        ) %>% mutate(baselinedOD = OD-medianBlankOD)

epoch.df <- inner_join(epoch.df %>% filter(Dilution < 5e-06) %>%
                          select(-Dilution, -Sample) %>% # get the blanks & calculate mean value for each Temp & Rep
                              group_by(Rep, Incubation) %>% summarise(medianBlankOD = median(OD, na.rm=TRUE)),
                       epoch.df %>% filter(Dilution > 5e-06) # add the medianBlankOD back to the data without the samples used for blanking
                      ) %>% mutate(baselinedOD = OD-medianBlankOD)

# estimate the mean CFU of each sample
plateCFU.df <- plateCFU.df %>% mutate(CFU_per_mL = `CFU per 100uL`/Dilution*10) %>%
                group_by(Sample, Phase, Incubation) %>%
                  summarise(meanCFU = mean(CFU_per_mL),
                            sdCFU = sd(CFU_per_mL))

# combine the CFU data with the OD data & infer the CFU for each dilution used in the OD data
synergy.df <- left_join(synergy.df %>% #Incubation column has different format than in plateCFU.df
                          mutate(temp="Erlenmeyer") %>% unite("Incubation", c(Incubation, temp), sep=" "),
                        plateCFU.df) %>%
                mutate(inferred_meanDensity = meanCFU*Dilution,
                       inferred_sdDensity = sdCFU*Dilution) %>%
                  select(-meanCFU, -sdCFU)

epoch.df <- left_join(epoch.df %>% #Incubation column has different format than in plateCFU.df
                          mutate(temp="Erlenmeyer") %>% unite("Incubation", c(Incubation, temp), sep=" "),
                      plateCFU.df) %>%
                mutate(inferred_meanDensity = meanCFU*Dilution,
                       inferred_sdDensity = sdCFU*Dilution) %>%
                  select(-meanCFU, -sdCFU)
```

```{r, calibration_EXP_3sp}
## do the calibration:
synergy.df <- synergy.df %>%
                mutate(log10_OD = log10(baselinedOD),
                       log10_density = log10(inferred_meanDensity)) %>%
                 filter(log10_OD > -Inf)

# plot the calibration curve for the Synergy
ggplot(synergy.df,
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Incubation)) +
  facet_wrap(vars(Sample)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Synergy: 3sp exponential")

# remove some of the data points because it seems we are hitting up against the limit of detection
synergy.df <- rbind(synergy.df %>% filter(Incubation!="40C Erlenmeyer", baselinedOD > 2e-02),
                    synergy.df %>% filter(Incubation=="40C Erlenmeyer", baselinedOD > 3.1e-02))

ggplot(synergy.df,
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Incubation)) +
  facet_wrap(vars(Sample)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Synergy: 3sp exponential")

# check for significant differences between growth conditions
synergy_lm <- with(synergy.df, lm(log10_density ~ log10_OD + Sample + Incubation + Sample:Incubation))
summary(synergy_lm)
rm(synergy_lm)

# estimate linear models for each condition and store the estimates
temp.fitVals = synergy.df %>% group_by(Sample, Incubation) %>%
                  do(tidy(lm(log10_density ~ log10_OD, data=.), conf.int=TRUE))
temp.fitVals <- temp.fitVals %>% separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask")) %>%
                  mutate(Phase="exponential", OD_temp=28, Detector="synergy")
temp.fitVals$Incubation_temp <- as.numeric(temp.fitVals$Incubation_temp)

all_calibrations <- rbind(all_calibrations, temp.fitVals)
rm(temp.fitVals)

# repeat for the cell size linear regression
temp.fitVals = synergy.df %>% group_by(Sample, Incubation) %>%
                 do(tidy(lm(log10_OD ~ log10_density, data=.), conf.int=TRUE)) %>%
                    filter(term == "log10_density")
temp.fitVals <- temp.fitVals %>% separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask")) %>%
                  mutate(Phase="exponential", OD_temp=28, Detector="synergy")
temp.fitVals$Incubation_temp <- as.numeric(temp.fitVals$Incubation_temp)

all_cellSizes <- rbind(all_cellSizes, temp.fitVals)
rm(temp.fitVals)

### Do the same thing for the Epoch data

epoch.df <- epoch.df %>%
              mutate(log10_OD = log10(baselinedOD),
                     log10_density = log10(inferred_meanDensity)) %>%
                 filter(log10_OD > -Inf)

# plot the calibration curve for the Epoch
ggplot(epoch.df,
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Incubation)) +
  facet_wrap(vars(Sample)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Epoch: 3sp exponential")

# remove some of the data points because it seems we are hitting up against the limit of detection
epoch.df <- rbind(epoch.df %>% filter(baselinedOD > 5e-03, inferred_meanDensity > 1e+03))

ggplot(epoch.df,
       aes(y=inferred_meanDensity,
           x=baselinedOD,
           colour=Incubation)) +
  facet_wrap(vars(Sample)) +
  scale_x_log10() +
  scale_y_log10() +
  geom_point() +
  geom_smooth(method="lm", linewidth=0.2) +
  labs(y="CFU Cell Density (1/mL)", x="OD (Absorbance at 600nm)",
       title="Epoch: 3sp exponential")

# check for significant differences between growth conditions
epoch_lm <- with(epoch.df, lm(log10_density ~ log10_OD + Sample + Incubation + Sample:Incubation))
summary(epoch_lm)
rm(epoch_lm)

# estimate linear models for each condition and store the estimates
temp.fitVals = epoch.df %>% group_by(Sample, Incubation) %>%
                  do(tidy(lm(log10_density ~ log10_OD, data=.), conf.int=TRUE))
temp.fitVals <- temp.fitVals %>% separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask")) %>%
                  mutate(Phase="exponential", OD_temp=28, Detector="epoch")
temp.fitVals$Incubation_temp <- as.numeric(temp.fitVals$Incubation_temp)

all_calibrations <- rbind(all_calibrations, temp.fitVals)
rm(temp.fitVals)

# repeat for the cell size linear regression
temp.fitVals = epoch.df %>% group_by(Sample, Incubation) %>%
                 do(tidy(lm(log10_OD ~ log10_density, data=.), conf.int=TRUE)) %>%
                    filter(term == "log10_density")
temp.fitVals <- temp.fitVals %>% separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask")) %>%
                  mutate(Phase="exponential", OD_temp=28, Detector="epoch")
temp.fitVals$Incubation_temp <- as.numeric(temp.fitVals$Incubation_temp)

all_cellSizes <- rbind(all_cellSizes, temp.fitVals)

# store the raw data
temp.data <- rbind(synergy.df %>% mutate(Detector="synergy", OD_temp=28),
                   epoch.df %>% mutate(Detector="epoch", OD_temp=28)) %>% ungroup() %>%
               select(-Rep, -medianBlankOD, -Dilution, -OD) %>%
                 separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask"))
temp.data$Incubation_temp <- as.numeric(temp.data$Incubation_temp)
all_calib.data <- rbind(all_calib.data, temp.data)

rm(epoch.df, synergy.df, plateCFU.df, temp.fitVals, temp.data)
```


# Comparison of Species & Growth conditions

Here is a plot of how the slope of the OD-to-CFU calibration curve (and its confidence intervals) depend on the species, incubation temperature, and phase of the culture.

```{r, compare_all}
ggplot(all_cellSizes %>% filter(Flask!="tube", Detector=="epoch") %>%
         mutate(Culture_temp = ifelse(Incubation_temp>30, 40, 25)), # for simplicity classify 28*C as 25*C incubation
       aes(x=Sample, y=estimate, colour=Phase)) +
  facet_wrap(vars(Culture_temp)) +
  geom_point(alpha=0.5) +
  geom_errorbar(aes(ymin=conf.low, ymax=conf.high),
                alpha=0.7, width=.1) +
  labs(y="Light scattered per CFU", x="Species") +
  scale_x_discrete(labels=c('P.veronii', 'P.knackmussii', 'P.putida', 'P.protegens')) +
  scale_colour_discrete(type=c("#00BE67", "#C77CFF")) +
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

ggplot(all_cellSizes %>% filter(Flask!="tube", Detector=="epoch"),
       aes(x=Sample, y=estimate, colour=Phase, shape=Flask)) +
  facet_wrap(vars(Incubation_temp)) +
  geom_point(alpha=0.5) +
  geom_errorbar(aes(ymin=conf.low, ymax=conf.high),
                alpha=0.7, width=.1) +
  labs(y="Slope of CFU vs OD", x="Species", title="epoch plate reader") +
  scale_x_discrete(labels=c('P.veronii', 'P.knackmussii', 'P.putida', 'P.protegens')) +
  scale_colour_discrete(type=c("#00BE67", "#C77CFF")) +
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

ggplot(all_cellSizes %>% filter(Flask!="tube", Detector=="synergy"),
       aes(x=Sample, y=estimate, colour=Phase, shape=Flask)) +
  facet_wrap(vars(Incubation_temp)) +
  geom_point(alpha=0.5) +
  geom_errorbar(aes(ymin=conf.low, ymax=conf.high),
                alpha=0.7, width=.1) +
  labs(y="Slope of CFU vs OD", x="Species", title="H1 plate reader") +
  scale_x_discrete(labels=c('P.veronii', 'P.knackmussii', 'P.putida', 'P.protegens')) +
  scale_colour_discrete(type=c("#00BE67", "#C77CFF")) +
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

ggplot(all_calibrations %>% filter(term=="log10_OD", Flask!="tube", Detector=="epoch"),
       aes(x=Sample, y=estimate, colour=Phase)) +
  facet_wrap(vars(Incubation_temp)) +
  geom_point() +
  geom_errorbar(aes(ymin=conf.low, ymax=conf.high), width=.05) +
  labs(y="Slope of calibration curve",
       title="Epoch") +
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

ggplot(all_calibrations %>% filter(term=="log10_OD", Flask!="tube", Detector=="synergy", Sample != "CK101"),
       aes(x=Sample, y=estimate, colour=Phase)) +
  facet_wrap(vars(Incubation_temp)) +
  geom_point() +
  geom_errorbar(aes(ymin=conf.low, ymax=conf.high), width=.05) +
  labs(y="Slope of calibration curve",
       title="Synergy") +
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

ggplot(all_calibrations %>% filter(term=="log10_OD", Flask!="tube", Detector=="epoch",
                                   Sample %in% c("BSC008", "BSC015")),
       aes(x=Phase, y=estimate, colour=Incubation_temp)) +
  facet_wrap(vars(Sample)) +
  geom_point() +
  geom_errorbar(aes(ymin=conf.low, ymax=conf.high), width=.05) +
  labs(y="Slope of calibration curve") +
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))

save(all_calibrations, file="OD_to_CFU_conversion.RData")
```

# Something more general
22 Nov 2024:

So all of that detail above is great but I need something more generally applicable... Let's consider only bacteria grown in the microplate. Then, we're interested in temperature as a fixed effect and sample as a random effect.

```{r, fit_all_data}
ggplot(all_calib.data,
       aes(x=inferred_meanDensity, y=baselinedOD, colour=Sample)) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10()

ggplot(all_calib.data,
       aes(x=inferred_meanDensity, y=baselinedOD, colour=Flask)) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10()

ggplot(all_calib.data %>% filter(Flask == "plate reader"),
       aes(x=inferred_meanDensity, y=baselinedOD, colour=Sample)) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10()

ggplot(all_calib.data %>% filter(Flask == "plate reader"),
       aes(x=inferred_meanDensity, y=baselinedOD, colour=Incubation_temp)) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10()

ggplot(all_calib.data %>% filter(Flask == "plate reader"),
       aes(x=inferred_meanDensity, y=baselinedOD, colour=Detector)) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10()

## pick a subset of the data for creating the conversion
conversion.data <- all_calib.data %>% filter(Flask == "plate reader") %>%
                      filter(Sample != "BSC004") # exclude right side outlier
# exclude left side outlier
conversion.data <- conversion.data[-which(conversion.data$Sample=="BSC015" & conversion.data$Incubation_temp==40 & conversion.data$Phase=="Stationary"),]

ggplot(conversion.data,
       aes(x=inferred_meanDensity, y=baselinedOD, colour=Sample)) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10()

# a linear model with density as the predictor
CFU_to_OD.lm <- with(conversion.data,
                     lm(log10_OD ~ log10_density))
summary(CFU_to_OD.lm)

# a linear model with OD as the predictor
OD_to_CFU.lm <- with(conversion.data,
                     lm(log10_density ~ log10_OD))

summary(OD_to_CFU.lm)

# functions to convert between these values
convert_CFU_to_OD <- function(CFU) {
  10^(coef(CFU_to_OD.lm)[1] + coef(CFU_to_OD.lm)[2]*log10(CFU))
}
convert_OD_to_CFU <- function(OD) {
  10^(coef(OD_to_CFU.lm)[1] + coef(OD_to_CFU.lm)[2]*log10(OD))
}

# check what these predictions look like
some_CFU_vals <- seq(from=3.000e+00, to=4.362e+10, length.out=10)
pred_OD <- sapply(some_CFU_vals,
                  convert_CFU_to_OD)

ggplot(conversion.data,
       aes(x=inferred_meanDensity, y=baselinedOD)) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10() +
  geom_line(data=data.frame(some_CFU_vals, pred_OD), aes(x=some_CFU_vals, y=pred_OD))

some_OD_vals <- seq(from=0.0051, to=1.3909, length.out=10)
pred_CFU <- sapply(some_OD_vals,
                   convert_OD_to_CFU)

ggplot(conversion.data,
       aes(y=inferred_meanDensity, x=baselinedOD)) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10() +
  geom_line(data=data.frame(some_OD_vals, pred_CFU), aes(x=some_OD_vals, y=pred_CFU))
```
