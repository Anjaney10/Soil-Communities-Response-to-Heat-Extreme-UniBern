---
title: "Thermal performance: CFUs and growth curves time-to-detection analyses"
author: "Hermina and Anjaney"
Date: "2025-02-05"
output:
  html_document:
    df_print: paged
    code_folding: hide
    toc: true
    toc_float:
      smooth_scroll: false
  pdf_document:
    toc: true
---

# Introduction

This notebook is for analyzing the temperature growth curves data produced by Anjaney and Hermina, as well as the survival CFU data produced by Hermina. It summarizes the findings for publication. This notebook was created by copying the relevant sections from `Anjaney_analysis--hermina_redo.Rmd` and `plate_reader_calibration.Rmd`.

The goal is to describe the thermal niche of different *Pseudomonas* strains present in the Terrestrial Ecology lab of Maddy Thakur (University of Bern). The main question the experiments are trying to answer: Is there a relationship between a strain's growth (fast VS slow grower) and its thermal niche?

See the associated manuscript for more details. This notebook covers all analyses performed for Experiment I in the manuscript.

## The data

16 soil *Pseudomonas* strains were used in total (BSC001 - BSC010, BSC015, BSC019, CK101 - CK104), inoculated either from early exponential phase or from stationary phase.

There are 3 data sets which are integrated in this analysis:

1. Colony forming unit (CFU) data for all 16 strains growing at 28C, 35C, and 40C.

2. Growth curves inoculated in a 10-fold serial dilution at 6 different starting concentrations ($N_0$) and 4 different temperatures (25C, 30C, 35C, and 40C). The CFU data is integrated into this analysis because it is used to infer the OD-converted inoculum size for each strain x temperature combination.

3. Dilution series performed on both of the microspectrophotometers in our lab. This is used to integrate the CFU data with the OD data (see above).

All data files and protocols are associated with the above analyses are available in the folder where this file is found.

Before we get started, let's load all the R packages and list the versions for reproducibility of the entire environment:

```{r, loadEnv}
# load environment
library(tidyverse)
library(readxl) # for importing data directly from Excel sheet
library(broom) # for easy fitting of several lm's from the same df

# print the complete info about packages and versions currently loaded in the environment:
sessionInfo()

# set theme for all plots
fave_theme <- theme_light() + # see other options at https://ggplot2.tidyverse.org/reference/ggtheme.html
  theme(text = element_text(size=15), # larger text size for titles & axes
        panel.grid.major = element_blank(), # remove major gridlines
        panel.grid.minor = element_blank()) # remove minor gridlines
theme_set(fave_theme)
```

# Plate reader calibration for CFU-to-OD conversion

Analysis of data generated by following the protocol called `OD Calibration to CFUs.docx`.

Fairly exhaustive calibrations were done for the microplate spectrophotometers (hereafter referred to generally as "plate readers" or specifically by the name of each instrument, BioTek Synergy H1 or Biotek Epoch2). Different *Pseudomonas* species were grown in different culture conditions (96-well microplate, tube, or Erlenmeyer), temperatures (25C or 40C), and culture phases (exponential or stationary). Then, dilution series were made. These were measured by spectrophotometer at 600nm (OD$_{600}$) and by CFU to get the calibration. There were a lot of inconsistencies; these are to be expected since OD measures the amount of scattered light, which depends in part on cell density but also on cell size, clumping, etc.

Anyway, I tried my best to estimate a calibration curve.

## Load & parse data

```{r, calib_load&baseline_ExpBSC015}
#####################################
# load the microplate OD data
#####################################
synergy.df <- read_excel("./data/calibration_spectrophotometers--22Feb24.xlsx", sheet="microplate H1") %>%
                pivot_longer(cols=`25_rep1`:`40_rep6`,
                                   names_to=c("Temp", "Rep"),
                                   names_pattern="(.*)_rep(.)",
                                   values_to="OD") # reorganize the shape of the dataframe
epoch.df <- read_excel("./data/calibration_spectrophotometers--22Feb24.xlsx", sheet="microplate Epoch") %>%
                pivot_longer(cols=`25_rep1`:`40_rep6`,
                                   names_to=c("Temp", "Rep"),
                                   names_pattern="(.*)_rep(.)",
                                   values_to="OD") # reorganize the shape of the dataframe

# load the microplate CFU data
plateCFU.df <- read_excel("./data/calibration_spectrophotometers--22Feb24.xlsx", sheet="microplate_CFU")

#####################################
# baseline subtract using the blanks as well as the bottom 3 lowest dilutions for each sample
#####################################

## check if there's any systematic trend in the baseline value
#baseline_trend <- rbind(synergy.df %>% add_column(machine="Synergy"), # combine the data from the 2 plate readers
#                        epoch.df %>% add_column(machine="Epoch")) %>%
#                    filter(Dilution < 5e-06) %>%                      # keep blanks & 3 lowest dilutions
#                      # get median value for each temperature & replicate
#                      select(-Dilution, -Sample) %>% group_by(Temp, Rep, machine) %>%
#                          summarise(medianBlankOD = median(OD, na.rm=TRUE),
#                                    ICR_lo = quantile(OD, probs=0.25),
#                                    ICR_hi = quantile(OD, probs=0.75))
#ggplot(baseline_trend, aes(x=Rep, y=medianBlankOD, colour=Temp)) +
#  facet_wrap(vars(machine), scales="free") +
#  geom_errorbar(aes(ymin=ICR_lo, ymax=ICR_hi), width=0.2) +
#  geom_point()
## there is NO systematic trend in the baseline value
#rm(baseline_trend)

# in this case it seems there's a difference in the baselines for different incubation temperatures, but only for the Epoch2...

# baseline everything in the same way as before
synergy.df <- inner_join(synergy.df %>% filter(Dilution < 5e-06) %>%
                            select(-Dilution, -Sample) %>% # get the blanks & calculate mean value for each Temp & Rep
                                group_by(Temp, Rep) %>% summarise(medianBlankOD = median(OD, na.rm=TRUE)),
                          synergy.df %>% filter(Dilution > 5e-06) # add the medianBlankOD back to the data without the samples used for blanking
                        ) %>% mutate(baselinedOD = OD-medianBlankOD)

epoch.df <- inner_join(epoch.df %>% filter(Dilution < 5e-06) %>%
                          select(-Dilution, -Sample) %>% # get the blanks & calculate mean value for each Temp & Rep
                              group_by(Temp, Rep) %>%
                                summarise(medianBlankOD = median(OD, na.rm=TRUE)),
                       epoch.df %>% filter(Dilution > 5e-06) # add the medianBlankOD back to the data without the samples used for blanking
                      ) %>% mutate(baselinedOD = OD-medianBlankOD)


#####################################
# estimate the mean CFU of each sample
#####################################
plateCFU.df <- plateCFU.df %>% mutate(CFU_per_mL = `CFU per 100uL`/Dilution*10) %>%
                group_by(Sample, Phase, Incubation) %>%
                  summarise(meanCFU = mean(CFU_per_mL),
                            sdCFU = sd(CFU_per_mL))

# combine the CFU data with the OD data & infer the CFU for each dilution used in the OD data
synergy.df <- left_join(synergy.df, plateCFU.df) %>%
                mutate(inferred_meanDensity = meanCFU*Dilution,
                       inferred_sdDensity = sdCFU*Dilution) %>%
                  select(-meanCFU, -sdCFU)

epoch.df <- left_join(epoch.df, plateCFU.df) %>%
                mutate(inferred_meanDensity = meanCFU*Dilution,
                       inferred_sdDensity = sdCFU*Dilution) %>%
                  select(-meanCFU, -sdCFU)

# remove some of the data points because it seems we are hitting up against the limit of detection
synergy.df <- synergy.df %>% filter(inferred_meanDensity > 5e+04,
                                    baselinedOD > 5e-03,
                                    Temp==25) # drop the 40C because it looks even worse than 25C
# remove some of the data points because it seems we are hitting up against the limit of detection
epoch.df <- epoch.df %>% filter(inferred_meanDensity > 1e+04,
                           baselinedOD > 5e-03,
                           Temp==25) # again remove OD acquisition temp of 40C

# create columns for log10 values
synergy.df <- synergy.df %>%
                mutate(log10_OD = log10(baselinedOD),
                       log10_density = log10(inferred_meanDensity)) %>%
                 filter(log10_OD > -Inf)
epoch.df <- epoch.df %>%
              mutate(log10_OD = log10(baselinedOD),
                     log10_density = log10(inferred_meanDensity)) %>%
                 filter(log10_OD > -Inf)

# store the raw data
all_calib.data <- rbind(synergy.df %>% mutate(Detector="synergy"),
                        epoch.df %>% mutate(Detector="epoch")) %>% ungroup() %>%
                    select(-Rep, -medianBlankOD, -Dilution, -OD, -Temp) %>%
                      separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask")) %>%
                        mutate(OD_temp=25)
all_calib.data$Incubation_temp <- as.numeric(all_calib.data$Incubation_temp)

rm(epoch.df, synergy.df, plateCFU.df)
```

Load additional data...

```{r, calib_load&baseline_Sta4sp}
# load the microplate OD data
synergy.df <- read_excel("./data/calibration_spectrophotometers--26Feb24.xlsx", sheet="microplate H1") %>%
                pivot_longer(cols =`rep1`:`rep6`,
                             names_to = "Rep",
                             names_pattern="rep(.)",
                             values_to="OD") %>% # reorganize the shape of the dataframe
                  mutate(OD_temp = 25)
epoch.df <- read_excel("./data/calibration_spectrophotometers--26Feb24.xlsx", sheet="microplate Epoch") %>%
              pivot_longer(cols =`rep1`:`rep6`,
                             names_to = "Rep",
                             names_pattern="rep(.)",
                             values_to="OD") %>% # reorganize the shape of the dataframe
                  mutate(OD_temp = 40)

# load the microplate CFU data
plateCFU.df <- read_excel("./data/calibration_spectrophotometers--26Feb24.xlsx", sheet="microplate_CFU")

# baseline subtract using the blanks as well as the bottom 1 lowest dilution for each sample

## check if there's any systematic trend in the baseline value
#baseline_trend <- rbind(synergy.df %>% add_column(machine="Synergy"), # combine the data from the 2 plate readers
#                        epoch.df %>% add_column(machine="Epoch")) %>%
#                    filter(Dilution < 1e-06) %>%                      # keep blanks & 3 lowest dilutions
#                      # get median value for each reader & replicate
#                      select(-Dilution, -Sample) %>% group_by(Rep, machine, Incubation) %>%
#                          summarise(medianBlankOD = median(OD, na.rm=TRUE),
#                                    ICR_lo = quantile(OD, probs=0.25, na.rm=TRUE),
#                                    ICR_hi = quantile(OD, probs=0.75, na.rm=TRUE))
#ggplot(baseline_trend, aes(x=Rep, y=medianBlankOD, colour=Incubation)) +
#  facet_wrap(vars(machine), scales="free") +
#  geom_errorbar(aes(ymin=ICR_lo, ymax=ICR_hi), width=0.2) +
#  geom_point()
## yes, there is a trend. But only for the Epoch2 plate reader and 25C data...
#rm(baseline_trend)

# remove the first 5 replicates in the "25C plate" Epoch data
epoch.df <- rbind(epoch.df %>% filter(Incubation == "25C plate reader", Rep==6),
                  epoch.df %>% filter(Incubation == "40C plate reader", Rep<6))
# & remove the 6th replicate in the "40C plate" Epoch data (that one is all NA's anyway)


# now, after excluding problematic values, baseline similarly to previous data:
synergy.df <- inner_join(synergy.df %>% filter(Dilution < 1e-06) %>%
                            select(-Dilution, -Sample) %>% # get the blanks & calculate mean value for each Temp & Rep
                                group_by(Rep, Incubation) %>% summarise(medianBlankOD = median(OD, na.rm=TRUE)),
                          synergy.df %>% filter(Dilution > 1e-06) # add the medianBlankOD back to the data without the samples used for blanking
                        ) %>% mutate(baselinedOD = OD-medianBlankOD)

epoch.df <- inner_join(epoch.df %>% filter(Dilution < 1e-06) %>%
                          select(-Dilution, -Sample) %>% # get the blanks & calculate mean value for each Temp & Rep
                              group_by(Rep, Incubation) %>% summarise(medianBlankOD = median(OD, na.rm=TRUE)),
                       epoch.df %>% filter(Dilution > 1e-06) # add the medianBlankOD back to the data without the samples used for blanking
                      ) %>% mutate(baselinedOD = OD-medianBlankOD)

# estimate the mean CFU of each sample
plateCFU.df <- plateCFU.df %>% mutate(CFU_per_mL = `CFU per 100uL`/Dilution*10) %>%
                group_by(Sample, Phase, Incubation) %>%
                  summarise(meanCFU = mean(CFU_per_mL),
                            sdCFU = sd(CFU_per_mL))

# combine the CFU data with the OD data & infer the CFU for each dilution used in the OD data
synergy.df <- left_join(synergy.df, plateCFU.df) %>%
                mutate(inferred_meanDensity = meanCFU*Dilution,
                       inferred_sdDensity = sdCFU*Dilution) %>%
                  select(-meanCFU, -sdCFU)

epoch.df <- left_join(epoch.df, plateCFU.df) %>%
                mutate(inferred_meanDensity = meanCFU*Dilution,
                       inferred_sdDensity = sdCFU*Dilution) %>%
                  select(-meanCFU, -sdCFU)

# remove some of the data points because it seems we are hitting up against the limit of detection
synergy.df <- rbind(synergy.df %>% filter(Sample=="BSC004", baselinedOD > 1e-02),
                    synergy.df %>% filter(Sample=="BSC008", Incubation=="25C plate reader", baselinedOD > 2e-02),
                    synergy.df %>% filter(Sample=="BSC008", Incubation=="40C plate reader", baselinedOD > 5e-02),
                    synergy.df %>% filter(Sample=="BSC015", Incubation=="25C plate reader", baselinedOD > 2e-02),
                    synergy.df %>% filter(Sample=="BSC015", Incubation=="40C plate reader", baselinedOD > 1e-02),
                    synergy.df %>% filter(Sample=="CK101", baselinedOD > 2e-02))
# remove the most concentrated samples because of violation of the Beer-Lambert law
synergy.df <- synergy.df %>% filter(baselinedOD < 1.4)

# remove some of the data points because it seems we are hitting up against the limit of detection
epoch.df <- rbind(epoch.df %>% filter(Sample %in% c("BSC004", "BSC008"), Incubation=="25C plate reader", baselinedOD > 5e-03),
                  epoch.df %>% filter(Sample %in% c("BSC015", "CK101"), Incubation=="25C plate reader", baselinedOD > 1e-02),
                  epoch.df %>% filter(Sample=="BSC015", Incubation=="40C plate reader", baselinedOD > 1e-02),
                  epoch.df %>% filter(Sample=="BSC008", Incubation=="40C plate reader", baselinedOD > 2e-02))
# remove the most concentrated samples because of violation of the Beer-Lambert law
epoch.df <- epoch.df %>% filter(baselinedOD < 1.1)


# get the log10 of the data
synergy.df <- synergy.df %>%
                mutate(log10_OD = log10(baselinedOD),
                       log10_density = log10(inferred_meanDensity)) %>%
                 filter(log10_OD > -Inf,
                        baselinedOD > 1e-13)

epoch.df <- epoch.df %>%
              mutate(log10_OD = log10(baselinedOD),
                     log10_density = log10(inferred_meanDensity)) %>%
                 filter(log10_OD > -Inf)

# store the raw data
temp.data <- rbind(synergy.df %>% mutate(Detector="synergy", OD_temp=25),
                   epoch.df %>% mutate(Detector="epoch", OD_temp=40)) %>% ungroup() %>%
               select(-Rep, -medianBlankOD, -Dilution, -OD) %>%
                 separate_wider_delim(Incubation, "C ", names=c("Incubation_temp", "Flask"))
temp.data$Incubation_temp <- as.numeric(temp.data$Incubation_temp)
all_calib.data <- rbind(all_calib.data %>% mutate(Sample = "BSC015"),
                        temp.data)

rm(epoch.df, synergy.df, plateCFU.df, temp.data)
```
Let's consider only bacteria grown in the microplate. Then, we're interested in temperature as a fixed effect and sample as a random effect.

```{r, calibration}
ggplot(all_calib.data %>% filter(Flask == "plate reader"),
       aes(x=inferred_meanDensity, y=baselinedOD, colour=Detector)) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10() +
  labs(title = "inocula grown in microplate")

## rather arbitrarily pick a subset of the data for creating the conversion
conversion.data <- all_calib.data %>% filter(Flask == "plate reader") %>%
                      filter(Sample != "BSC004") # exclude right side outlier
# exclude left side outlier
conversion.data <- conversion.data[-which(conversion.data$Sample=="BSC015" & conversion.data$Incubation_temp==40 & conversion.data$Phase=="Stationary"),]

# plot the final data that will be used for the conversion estimate:
ggplot(conversion.data, # here in terms of species
       aes(x=inferred_meanDensity, y=baselinedOD, colour=Sample)) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10() +
  labs(title = "data used for CFU to OD conversion")
# plot again in terms of the microplate reader
ggplot(conversion.data,
       aes(x=inferred_meanDensity, y=baselinedOD, colour=Detector)) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10() +
  labs(title = "data used for CFU to OD conversion")
# and again in terms of incubation temperature
ggplot(conversion.data,
       aes(x=inferred_meanDensity, y=baselinedOD, colour=Incubation_temp)) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10() +
  labs(title = "data used for CFU to OD conversion")

# a linear model with density as the predictor
CFU_to_OD.lm <- with(conversion.data,
                     lm(log10_OD ~ log10_density))
summary(CFU_to_OD.lm)

# a function to convert from CFU to OD
convert_CFU_to_OD <- function(CFU) {
  10^(coef(CFU_to_OD.lm)[1] + coef(CFU_to_OD.lm)[2]*log10(CFU))
}

# check what these predictions look like
some_CFU_vals <- seq(from=3.000e+00, to=4.362e+10, length.out=10)
pred_OD <- sapply(some_CFU_vals,
                  convert_CFU_to_OD)

ggplot(conversion.data,
       aes(x=inferred_meanDensity, y=baselinedOD)) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10() +
  geom_line(data=data.frame(some_CFU_vals, pred_OD), aes(x=some_CFU_vals, y=pred_OD)) +
  labs(title = "checking CFU to OD conversion (line) against data (points)")

# clean up
rm(all_calib.data, conversion.data, pred_OD, some_CFU_vals)
```


# Analysis of CFU data

# Analysis of growth curve

This is a quick analysis of the data that uses a coarse-grained approximation of the time-to-detection (TTD) as a proxy of a strain's growth. Note that TTD is inversely related to growth rate: a fast growing strain will have a shorter TTD and a slow growing strain will have a longer TTD.
